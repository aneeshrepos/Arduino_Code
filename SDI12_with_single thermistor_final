#include <SDI12.h>
#include <math.h>

#define SDI12_DATA_PIN 2
#define R_FIXED 10000.0    // 10k fixed resistor

// Thermistor pins
const uint8_t thermPins[3] = {A0, A1, A2};

SDI12 sdi12(SDI12_DATA_PIN);

char sensorAddress = '0';
bool measurementReady = false;

// Steinhart–Hart coefficients fitted to 10K3MCD1
const float A = 0.001129098;
const float B = 0.000234132;
const float C = 0.0000000876505;

// ---- Read thermistor on given pin, return °C ----
float readTemperatureC(uint8_t pin) {
  int adc = analogRead(pin);
  if (adc <= 0 || adc >= 1023) return NAN;

  // Low-side NTC divider math
  float rTherm = R_FIXED * ((float)adc / (1023.0 - adc));

  float lnR = log(rTherm);
  float tempK = 1.0 / (A + B * lnR + C * lnR * lnR * lnR);

  return tempK - 273.15;
}

// ---- Helper for sending SDI-12 response ----
void sendResponse(String response) {
  response += "\r\n";
  Serial.print("Sending response: ");
  Serial.print(response);
  delay(12);  // SDI-12 settle time
  sdi12.sendResponse(response);
}

void setup() {
  Serial.begin(115200);
  while (!Serial) {}

  Serial.println("SDI-12 3x Thermistor Sensor (10K3MCD1)");

  for (uint8_t i = 0; i < 3; i++) {
    pinMode(thermPins[i], INPUT);
  }

  sdi12.begin();
  sdi12.forceListen();
  delay(200);
}

void loop() {
  if (sdi12.available()) {
    String cmd = sdi12.readStringUntil('!');
    cmd += '!';
    cmd.trim();

    Serial.print("Received command: ");
    Serial.println(cmd);

    // ---- Address query ----
    if (cmd == "?!" || cmd == String(sensorAddress) + "?!") {
      sendResponse(String(sensorAddress));
    }

    // ---- Change address (aAb!) ----
    else if (cmd.length() == 4 && cmd[1] == 'A' && cmd[3] == '!') {
      if (cmd[0] == sensorAddress) {
        sensorAddress = cmd[2];
        sendResponse(String(sensorAddress));
      }
    }

    // ---- Measurement request (aM!) ----
    else if (cmd == String(sensorAddress) + "M!") {
      Serial.println("Measurement command received");

      // 001 seconds, 3 values
      sendResponse(String(sensorAddress) + "0013");
      measurementReady = true;
    }

    // ---- Data request (aD0!) ----
    else if (cmd == String(sensorAddress) + "D0!" && measurementReady) {
      Serial.println("Sending temperature data");

      float t[3];
      for (uint8_t i = 0; i < 3; i++) {
        t[i] = readTemperatureC(thermPins[i]);
      }

      String dataResponse = String(sensorAddress);

      for (uint8_t i = 0; i < 3; i++) {
        if (isnan(t[i])) {
          dataResponse += "+999.9";
        } else {
          dataResponse += (t[i] >= 0 ? "+" : "") + String(t[i], 2);
        }
      }

      sendResponse(dataResponse);
      measurementReady = false;
    }

    // ---- Clear buffer ----
    while (sdi12.available()) sdi12.read();
    sdi12.forceListen();
  }

  delay(5);
}
